[
{
"alert.track": "0",
"alert_type": "always",
"is_scheduled": "0",
"name": "DeploymentServerAppEvents",
"owner": "nobody",
"search": "| tstats latest(data.appName) as appName latest(data.serverClassName) as serverClassName latest(data.action) as action \n         latest(data.result) as result latest(data.failedReason) as failedReason \n         latest(data.checksum) as checksum latest(data.timestamp) as timestamp latest(data.clientId) as clientId \n         where index=_dsappevent earliest=$reloadTime$ data.clientId IN ($clientIdList$) $result$ by data.key \n| stats list(appName) as appName list(serverClassName) as serverClassName list(action) as action list(result) as result list(failedReason) as failedReason \n        list(checksum) as checksum list(timestamp) as timestamp count(appName) as countApps by clientId",
"sharing": "app"
},
{
"alert.track": "0",
"alert_type": "always",
"is_scheduled": "0",
"name": "DeploymentServerClients",
"owner": "nobody",
"search": "| tstats prestats=t latest(data.lastPhoneHomeTime) values(data.lastPhoneHomeTime) latest(data.updaterRunning) where index=_dsphonehome earliest=$reloadTime$ latest=now `filter_by_client_id(\"$clientId$\")` by data.clientId ``` Obtain phonehome values to calculate average PH time.``` \n```Obtain data from dsclient index to enrich phonehome data with client information.``` \n| tstats prestats=t append=t latest(data.build) latest(data.connectionId) latest(data.dns) \n           latest(data.guid) latest(data.hostname) latest(data.instanceId) \n           latest(data.instanceName) latest(data.ip) latest(data.mgmt) latest(data.name) latest(data.package) \n           latest(data.packageType) latest(data.splunkVersion) latest(data.utsname) where index=_dsclient earliest=1 latest=now `filter_by_client_id(\"$clientId$\")` by \n           data.clientId \n```Instead of doing join operation on dsclient index, previous tstats queries obtain data from relevant indexes and merge them with stats command.``` \n| stats latest(data.lastPhoneHomeTime) as lastPhoneHomeTime values(data.lastPhoneHomeTime) as allphs latest(data.updaterRunning) as updaterRunning latest(data.build) as data.build latest(data.connectionId) as data.connectionId latest(data.dns) as data.dns \n           latest(data.guid) as data.guid latest(data.hostname) as data.hostname latest(data.instanceId) as data.instanceId \n           latest(data.instanceName) as data.instanceName latest(data.ip) as data.ip latest(data.mgmt) as data.mgmt latest(data.name) as data.name latest(data.package) as data.package \n           latest(data.packageType) as data.packageType latest(data.splunkVersion) as data.splunkVersion latest(data.utsname) as data.utsname by data.clientId \n```Discard entries from dsclient that do not have a matching entry from dsphonehome index. This emulates join operation.``` \n```A reverse is not necessary - every client that stored phonehome data will have a corresponding entry in dsclient index.``` \n| where lastPhoneHomeTime!=\"\" \n| search `filter_by_phonehome($minPhoneHomeTime$)` \n```Obtain time after the initial processing of the phonehomes is finished.``` \n```Extract last 4 phonehomes and calculate averagePhoneHomeInterval``` \n| eval last4phs=mvindex(allphs,-4,-1) \n``` First phoneHome is the oldest one``` \n| eval oldestph=mvindex(last4phs,0) \n| eval newestph=mvindex(last4phs,-1) \n| eval deltacount=max(1,mvcount(last4phs)-1) \n| eval averagePhoneHomeInterval=floor((newestph-oldestph)/deltacount) \n```Use time() instead of now(), since now() runs at the beginning of search which makes it possible for lastPhoneHomeTime > now``` \n```Use floor() to discard millisecond resolution``` \n| eval actual_ratio=(floor(time())-lastPhoneHomeTime)/averagePhoneHomeInterval \n| search `filter_by_ratio(\"$greater_than$\", $ratio$)` \n| fields - allphs oldestph newestph deltacount last4phs \n```Enrich client data with its latest applications data``` \n| join data.clientId type=left max=0 [ \n    ```Obtain latest application status.``` \n    | tstats latest(data.appName) as appName latest(data.serverClassName) as serverClassName \n      latest(data.action) as action latest(data.result) as result latest(data.failedReason) as failedReason \n      latest(data.checksum) as checksum latest(data.timestamp) as timestamp latest(data.clientId) \n      as data.clientId where index=_dsappevent earliest=$reloadTime$ latest=now \n      `filter_by_client_id(\"$clientId$\")` `filter_by_app(\"$appName$\")` `filter_by_action(\"$action$\")` `filter_by_checksum($checksum$)` \n      `filter_by_error(\"$has_error$\")` by data.key \n    | stats list(appName) as appName list(serverClassName) as serverClassName \n      list(action) as action list(result) as result list(failedReason) as failedReason \n      list(checksum) as checksum list(timestamp) as timestamp count(appName) as countApps by data.clientId \n    | eval appName=mvjoin(appName, \"#\") \n    | eval serverClassName=mvjoin(serverClassName, \"#\") \n    | eval action=mvjoin(action, \"#\") \n    | eval result=mvjoin(result, \"#\") \n    | eval failedReason=mvjoin(failedReason, \"#\") \n    | eval checksum=mvjoin(checksum, \"#\") \n    | eval timestamp=mvjoin(timestamp, \"#\") \n    ] \n| eval appName=split(appName, \"#\") \n| eval serverClassName=split(serverClassName, \"#\") \n| eval action=split(action, \"#\") \n| eval result=split(result, \"#\") \n| eval failedReason=split(failedReason, \"#\") \n| eval checksum=split(checksum, \"#\") \n| eval timestamp=split(timestamp, \"#\") \n| search `filter_by_app_count(\"$has_app_filter$\")` \n| rename data.* as *",
"sharing": "app"
},
{
"alert.track": "0",
"alert_type": "always",
"is_scheduled": "0",
"name": "DeploymentServerClientsBasic",
"owner": "nobody",
"search": "| tstats prestats=t latest(data.lastPhoneHomeTime) where index=_dsphonehome earliest=$reloadTime$ latest=now by data.clientId \n| tstats prestats=t append=t latest(data.build) latest(data.connectionId) latest(data.dns) \n           latest(data.guid) latest(data.hostname) latest(data.instanceId) \n           latest(data.instanceName) latest(data.ip) latest(data.mgmt) latest(data.name) latest(data.package) \n           latest(data.packageType) latest(data.splunkVersion) latest(data.utsname) where index=_dsclient earliest=1 latest=now \n           by data.clientId \n| stats latest(data.lastPhoneHomeTime) as lastPhoneHomeTime latest(data.build) as data.build latest(data.connectionId) as data.connectionId latest(data.dns) as data.dns \n           latest(data.guid) as data.guid latest(data.hostname) as data.hostname latest(data.instanceId) as data.instanceId \n           latest(data.instanceName) as data.instanceName latest(data.ip) as data.ip latest(data.mgmt) as data.mgmt latest(data.name) as data.name latest(data.package) as data.package \n           latest(data.packageType) as data.packageType latest(data.splunkVersion) as data.splunkVersion latest(data.utsname) as data.utsname by data.clientId \n| where lastPhoneHomeTime != \"\" \n| where \"data.dns\" != \"\" \n| rename data.* as * \n| eventstats count as total \n| head $offset_end$ \n| streamstats count as paginator \n| where paginator>$offset_start$",
"sharing": "app"
},
{
"alert.track": "0",
"alert_type": "always",
"is_scheduled": "0",
"name": "DeploymentServerClientsByMachineType",
"owner": "nobody",
"search": "| tstats dc(sourcetype) AS sourcetypeCount values(data.utsname) as utsname \n  where (index=_dsphonehome earliest=$reloadTime$ ) OR index=_dsclient by data.clientId \n| where sourcetypeCount = 2```it works as inner join``` \n| stats count(utsname) as clients by utsname",
"sharing": "app"
},
{
"alert.track": "0",
"alert_type": "always",
"is_scheduled": "0",
"name": "DeploymentServerEventsWithError",
"owner": "nobody",
"search": "| tstats latest(data.failedReason) as failedReason latest(data.action) as action latest(data.timestamp) as timestamp \n            where index=_dsappevent earliest=$reloadTime$ data.result != Ok \n            by data.serverClassName, data.appName, data.clientId \n         | rename data.* as *",
"sharing": "app"
},
{
"alert.track": "0",
"alert_type": "always",
"is_scheduled": "0",
"name": "DeploymentServerGetClientsUri",
"owner": "nobody",
"search": "| tstats latest(_time) as latesttime latest(data.ip) as latestip latest(data.mgmt) as latestmgmt \nwhere index=_dsclient earliest=1 by data.clientId \n| strcat \"https://\" latestip \":\" latestmgmt clientUri \n| fields - latestip latestmgmt",
"sharing": "app"
},
{
"alert.track": "0",
"alert_type": "always",
"is_scheduled": "0",
"name": "DeploymentServerGetPhonehomedClients",
"owner": "nobody",
"search": "| tstats dc(data.clientId) as clients where index=_dsphonehome earliest=$earliest$",
"sharing": "app"
},
{
"alert.track": "0",
"alert_type": "always",
"is_scheduled": "0",
"name": "DeploymentServerHasDeploymentErrorsPerAppAndServerclass",
"owner": "nobody",
"search": "| tstats count where index= _dsappevent earliest=$reloadTime$ $result$ $appName$ $serverClassNames$ \n           data.action=Download OR data.action=Install by data.clientId \n         | stats count as clients",
"sharing": "app"
},
{
"alert.track": "0",
"alert_type": "always",
"is_scheduled": "0",
"name": "DeploymentServerLookupClient",
"owner": "nobody",
"search": "| search index=_dsclient data.clientId = $clientId$ \n         | rename data.* as * \n         | head 1",
"sharing": "app"
},
{
"alert.track": "0",
"alert_type": "always",
"is_scheduled": "0",
"name": "DeploymentServerRecentDownloads",
"owner": "nobody",
"search": "| tstats latest(data.result) as result latest(data.action) as action \nwhere index=_dsappevent data.action!=Install earliest=$earliest$ latest=now \nby data.clientId data.serverClassName data.appName \n| search result=Ok action=Download \n| stats count as downloads",
"sharing": "app"
}
]
