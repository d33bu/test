[
{
"action.email.useNSSubject": "1",
"action.webhook.enable_allowlist": "0",
"alert.track": "0",
"alert_type": "always",
"dispatch.earliest_time": "-7d@h",
"dispatch.latest_time": "now",
"display.general.type": "statistics",
"display.page.search.tab": "statistics",
"is_scheduled": "0",
"name": "audit_trail_knowledge_objects_query",
"owner": "admin",
"request.ui_dispatch_app": "audit_trail",
"request.ui_dispatch_view": "search",
"search": "```Firstly filter out capability checks and non CRUD, non knowledge objects audit logs```\n    index=_audit  | where isnull(cap) AND NOT info IN (\"granted\", \"denied\") | search action IN (\"create_*\", \"update_*\", \"updated_*\", \"edit_*\", \"remove_*\", \"delete_*\", \"disable_*\", \"new_*\", \"move_*\", \"enable_*\", \"acl_*\") | search action IN (\"*_user\", \"*_saved_search\", \"*_data_model_file\", \"*_event_type\", \"*_tag\", \"*_fields_*\", \"*_lookup_table\", \"*_ui_view*\", \"*_ui_panel\", \"*_macro\", \"*_command\")\n    ```Filter out audit v2 logs```\n    | search sourcetype=\"audittrail\"\n    ```Extract object type and action```\n    |  rex action=\"(?<object_action>[a-zA-Z]+)_(?<object_type>[a-zA-Z_]*),\"\n    ```Extract application name```\n    | rex field=info \"app=\\\"(?<apptmp>.*)\\\"\" \n    | eval appnametmp=IF(!isnull(apptmp),apptmp,IF(isnull(app),\"-missing-\",app) )\n    | rex field=appnametmp \"'(?<apptmp2>.*)'\" \n    | eval appname=IF(!isnull(apptmp2),apptmp2,appnametmp) \n    ```Unify object name```\n    | eval name=IF(object_type=\"user\",username,name)  \n    | eval name=IF(object_type=\"saved_search\",savedsearch_name,name)\n    |  eval name=IF(!isnull(name),name,\"-missing-\")\n    ```Tags may have mnulti values: {[0]='tag_1' [1]='tag_2'}- split it to separate events```\n    | eval tagnames=split(replace(name, \"\\\\[[0-9]*\\\\]=\",\"\"), \"' '\") |  mvexpand tagnames | eval name=ltrim(rtrim(tagnames,\"'}\"),\"{'\")\n    ```Extract host name from fqdn```\n    | eval host=mvindex(split(host,\".\"),0)\n    ```Finally rename object type and actions to user friendly ones```\n    | lookup object_types_normalization ORIG_OBJECT_TYPE AS object_type OUTPUT DEST_OBJECT_TYPE AS object_type\n    | lookup action_types_normalization ORIG_ACTION AS object_action OUTPUT DEST_ACTION AS object_action\n    ```Preserve original event body```\n    |  eval orig_body=_raw\n    ```Apply filtering in the base search to avoid 'unknown sid' issue```\n    ```| where \"text_token$\"=\"-\" OR orig_body like \"%text_token$%\"``` \n    | stats count by _time, user, action, name, appname, host, info, object_type, object_action, orig_body",
"sharing": "app"
},
{
"alert.track": "0",
"alert_type": "always",
"dispatch.earliest_time": "-24h@h",
"dispatch.latest_time": "now",
"is_scheduled": "0",
"name": "audit_trail_users_query",
"owner": "admin",
"search": "```filter out capability checks, internal users and quota checks``` \n             index=_audit NOT info IN (denied, granted, \"denied *\", \"granted *\") NOT cap=1  NOT action=quota user IN ($ss_user_names$) host IN ($ss_host_names$) $ss_text$ \n                ```Filter out audit v2 logs```\n               | search sourcetype=\"audittrail\"\n               | rex field=_raw \"user=(?<auditrep_user>[a-zA-Z0-9/\\s_\\.-]*),\" \n               | rex field=_raw \"action=(?<auditrep_action>[a-zA-Z0-9_\\s]*),\" \n               ```calculate user_action to get rid of spaces``` \n               | eval user_action=lower(replace(auditrep_action, \"\\s\", \"_\")) \n               ```filter out internal or unknown users, preserve specific actions``` \n               | eval auditrep_user=IF(auditrep_user == \"n/a\" AND user_action IN (\"splunkstarting\", \"splunkshuttingdown\"), \"unknown\", auditrep_user) \n               | search NOT auditrep_user IN (\"n/a\", internal_observability, splunk-system-user, internal_automation, soar_proxy_user, soar_automation_user) \n               ```filter out SCS events``` \n               | spath input=info path=generated_by output=scs_generated_by | where isnull(scs_generated_by) \n               ```filter out internal automated non-human actions``` \n               | search NOT user_action IN (validate_token, get_password, alert_fired, list_scs_token) \n               ```calculate useragent_prefix for login_attempt actions``` \n               | eval normalized_useragent=IF(user_action==\"login_attempt\" AND (isnull(useragent) OR useragent=\"\"), \"unknown\", useragent) \n               | eval useragent_prefix=IF(user_action==\"login_attempt\", mvindex(split(mvindex(split(normalized_useragent,\"/\"),0), \" \"), 0), \"n/a\") \n               ```filter out cancelled searches, searches ran by scheduler and subsearches``` \n               | eval skip=\"0\" \n               | eval skip=IF(user_action==\"search\" AND (info==\"cancel\" OR info==\"canceled\" OR provenance=\"scheduler\" OR search_id like \"'subsearch_%\"), \"1\", skip) \n               ```| eval skip=IF(user_action==\"login_attempt\" AND useragent_prefix != \"Mozilla\", \"1\", skip)  ``` \n               | search skip=\"0\" \n               ```calculate extended user_action - ex_user_action``` \n               | rex field=user_action \"(?<object_action>[a-zA-Z]+)_(?<object_type>[a-zA-Z_]*)\" \n               | eval ex_user_action=user_action \n               | eval object_name=name \n               | eval object_name=IF(object_type==\"saved_search\", savedsearch_name, object_name) \n               | eval object_name=IF(object_type==\"token\", tokenId, object_name) \n               | eval object_name=IF(object_type==\"user\", IF(isnull(username), user, username), object_name) \n               | eval object_name=IF(object_type==\"app\", IF( NOT isnull(app_name), app_name, IF(NOT isnull(app), app, object_name)), object_name) \n               | eval object_name=IF(object_type==\"saml_group_map\", group, object_name) \n               | eval object_name=IF(object_type==\"datamodel\", IF(isnull(object_name), displayName, object_name), object_name) \n               | eval object_name=IF(object_type==\"password\", password_id, object_name) \n               | eval ex_user_action=IF(object_action IN (\"edit\", \"create\", \"new\", \"remove\", \"delete\", \"update\", \"updated\", \"disable\", \"enable\", \"move\", \"install\") AND NOT isnull(object_name) AND NOT lower(provenance)==\"n/a\", ex_user_action.\"@\".object_name, ex_user_action) \n               | eval ex_user_action=IF(user_action like \"login_attempt%\" OR user_action like \"logout%\" , ex_user_action.\"@\".user, ex_user_action) \n               ```search is treated a little differently``` \n               | eval object_name=IF(user_action==\"search\", IF(NOT isnull(provenance) AND NOT provenance==\"N/A\", provenance, \n                                                                   IF(NOT isnull(savedsearch_name) AND savedsearch_name != \"\", savedsearch_name, \"noname_search\")), object_name) \n               | eval ex_user_action=IF(user_action==\"search\", \"search@\".object_name, ex_user_action) \n               ```Preserve original event body``` \n               |  eval orig_body=_raw \n               | eval object_name=IF(isnull(object_name), \"n/a\", object_name) \n               | eval host=IF(isnull(host), \"n/a\", host) \n               | eval app=IF(isnull(app), \"n/a\", app) \n               | eval useragent=IF(isnull(useragent_prefix), \"n/a\", useragent_prefix) \n               | eval user=auditrep_user \n               | stats count by _time, user, user_action, ex_user_action, app,  object_name, host, useragent, info, orig_body",
"sharing": "app"
}
]
